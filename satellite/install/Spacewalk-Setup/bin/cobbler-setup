#!/usr/bin/env python
from cobbler.yaml import loadFile
from Cheetah.Template import Template
from socket import gethostbyname, gethostname
import shutil
from os.path import exists, join, dirname, basename, isdir, isfile
from os import system

TEMPLATES_DIR = '/usr/share/cobbler/installer_templates'
MODULES_TEMPLATE = join(TEMPLATES_DIR, 'modules.conf.template')
SETTINGS_TEMPLATE = join(TEMPLATES_DIR, 'settings.template')
DEFAULTS = join(TEMPLATES_DIR, 'defaults')

CONFIG_DIR = '/etc/cobbler/'
MODULES = join(CONFIG_DIR, 'modules.conf')
SETTINGS = join(CONFIG_DIR, 'settings')

TEMP_MODULES = '/tmp/modules.conf'
TEMP_SETTINGS = '/tmp/settings'

def copy(src, dest):
    if exists(dest):
        if isfile(dest):
            shutil.copy(dest, dest + ".old")
        elif isdir(dest) and isfile(src) and exists(join(dest, basename(src))):
            shutil.copy(join(dest,basename(src)), join(dest,basename(src)) + ".old")
    shutil.copy(src, dest)

def gen_template(template, answers, output):
	t = template.Template(file=template, searchList=answers)
	open(output,"w").write(t.respond())

def main():
    answers = cyaml.loadFile(DEFAULTS).next()
    answers['server'] = gethostbyname(gethostname())
    answers['next_server'] = answers['server']
    answers['redhat_management_server'] = answers['server']
    answers['redhat_management_type'] = 'site'
    answers['authn_module'] = 'authn_spacewalk'
    gen_template(SETTINGS_TEMPLATE, answers, TMP_SETTINGS)
    gen_template(MODULES_TEMPLATE, answers, TMP_MODULES)
    copy(TMP_SETTINGS, SETTINGS)
    copy(TMP_MODULES, MODULES)
    
if __name__=="__main__":
    main()