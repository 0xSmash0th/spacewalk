Upgrading an RHN Satellite Server on Red Hat Enterprise Linux 2.1AS or 3AS to 
v5.x on Enterprise Linux 4AS

     *** Follow the instructions *precisely* and all should be well ***


The following are instructions for upgrading from an RHN Satellite v3.x, 4.x 
or 5.0 to v5.1, while migrating the underlying operating system as well: Red 
Hat Enterprise Linux version 2.1AS or 3AS to 4AS.

NOTE:
   OS = Operating System
   RHN = Red Hat Network

PREPARATION:
------------
See PREPARATION section in parent README file.


BASIC STEP SUMMARY
(see the following section for more details):
---------------------------------------------
 1. If non-embedded, choose one of two upgrade steps early in the process.
 2. Disable the old RHN Satellite in the RHN Hosted environment (connected
    satellites only) and free up its operating system entitlement.
 3. Build a separate Red Hat Enterprise Linux 4AS.
    according to the specifications of the Red Hat Network Satellite Guide.
 4. Mount the new RHN Satellite ISO (without running the installation program).
 5. Perform the command-line portion of the RHN Satellite Server v5.x
    installation.
 6. Ensure ORACLE_HOME is set
 7. Shut down RHN Satellite services.
 8. Restore /var/satellite, /var/www/html/pub, /root/ssl-build,
    /etc/rhn/rhn.conf and /etc/tnsnames.ora to the new server.
9a. Restore database from backup.
9b. Restart the database (embedded only).
10a. Convert database schema (your DBA may want to do this for you).
10b. Activate the RHN Satellite with the new RHN certificate.
11. Redeploy configuration settings.
12. Add missing header value.
13. Restart services.
14. Insert the SSL CA public certificate into the database.
15. Enable monitoring and/or push functionality.
16. Verify rhn.conf settings.
17. Test/verify new RHN Satellite.


IN MORE DEPTH:
--------------
1. If non-embedded, choose one of two upgrade steps early in the process:
   a. have a new instance available for a brief completion of this process
   b. reuse the current instance, but it will be destroyed, reconstructed
      and then upgraded.
   Pick one of those processes. If (a), please have that instance ready.

2. disable the old RHN Satellite in the RHN Hosted environment (connected
   satellites only) and free up its operating system entitlement:

   - If you do not have another management entitlement, we recommend you
     acquire one, or simply delete the old RHN Satellite Server system profile.

   - Deactivate the old RHN Satellite's satellite certificate and free up the
     operating system entitlement used by the old RHN Satellite. On the hosted
     website:

      - https://rhn.redhat.com/rhn/systems/SatelliteList.do
        Find the old RHN Satellite's system profile and click on it.
      - Click the "Satellite" link.
      - "Deactivate Satellite License"
      - "Confirm Deactivation"

      - From there, continue and disable the Base Channel:
         - Click on "Details" 
         - Click on "Alter Channel Subscriptions"
         - To the left of the "Modify Base Channel" button, change the Base
         Software Channel to "(none, disable service)".
         - Click "Modify Base Channel"

3. Build a separate Red Hat Enterprise Linux 4AS according to the 
   specifications of the Red Hat Network Satellite Guide.

   Ensure you remap the old RHN Satellite's hostname to this new
   server.

   ** For proper installation, the hostname of the new server must be
      the same as the hostname of the old server at installation
      time.

   NOTE:
      If installed, remove the specspo package from the new server
      rpm -e specspo

4. Mount the new RHN Satellite ISO (without running the installation program):
   Ensure the ISO matches the operating system of the server you are
   installing it on.

5. Perform the command-line portion of the RHN Satellite Server v5.1
   installation:

      ./install.pl 

   Note:
   If you are running your Satellite in disconnected mode, then pass the
   --disconnected option to the install.pl command line:

      ./install.pl --disconnected

   You will see a message advising you to create the satellite administrator
   account. Ignore this message. 

6. At this point, you will need to log out of your terminal session and log 
   back in.  Verify that the $ORACLE_HOME environment variable has been 
   configured:
      echo $ORACLE_HOME
     
   You should see: '/usr/lib/oracle/10.2.0/client'

7. Shut down RHN Satellite services on the new system: 
      /sbin/service rhn-satellite stop

8. Restore /var/satellite, /var/www/html/pub, /root/ssl-build,
   /etc/rhn/rhn.conf, and /etc/tnsnames.ora to the new server.

   WARNING - do not restore the /etc/rhn/default/ directory. Old versions of
   default config files are often not compatible with the current versions.

   For a non-embedded version of RHN Satellite, if option 1a was
   chosen:
      o Obtain the proper tnsnames.ora and database connect string for
        the new database instance.  Your DBA should be able to provide
        these to you.
      o Save the tnsnames.ora provided by your DBA and put that file on
        the new system instead of the file from the original satellite
        machine.
      o Test the database connect string with sqlplus:
           sqlplus username/password@sid
        - You should see the oracle version, and an SQL> prompt.  Press
          Ctrl-d to exit sqlplus.
      o Edit the rhn.conf that is to be deployed on the new satellite,
        and set the 'default_db' to the new connect string.

   Install the rhn-httpd-ssl-key-pair-*-noarch.rpm file:
      rpm -Uvh /root/ssl-build/<MACHINE_NAME>/rhn-httpd-ssl-key-pair-<VERSION>.noarch.rpm

      or

      rpm -Uvh /root/ssl-build/<MACHINE_NAME>/rhn-org-httpd-ssl-key-pair-<VERSION>.noarch.rpm

9a. Restore database from backup:

   For embedded only:
      - scp the database backup from the old server to the new server,
        ensuring you also locate and copy the backup-log.dat file from the
        old server to the new server.  These files should all be
        copied to a single directory, preferably under /tmp.
      - restore the database from backup: refer to product
        documentation for instructions pertaining to this:

        http://www.redhat.com/docs/manuals/satellite/Red_Hat_Network_Satellite-5.0.0/html/Installation_Guide/s2-rhn-db-control-restore.html

   For non-embedded databases:
      1a: point the new RHN Satellite at the previous database. Give
          the temporary instances back to your DBA.
      1b: restore the database from backup - your DBAs can do this for you.

9b. Restart the database (embedded only) if not already started: 
    /sbin/service rhn-database start

    Remember to run this command as root, not as oracle.

   Verify that database tablespaces have some free space. The database
   schema upgrade scripts below may insert/update some data and cause
   the tablespaces to run out of space if it is close to full. The 
   db-control report command can be useful for quick review.

10a. Convert database schema (your DBA may want to do this for you):
   Install the rhn-upgrade package, either using
           up2date -i rhn-upgrade
   or by downloading the rpm manually and running
           rpm -ivh rhn-upgrade-*.rpm

   NOTE 1: these scripts generate log files. After running a script, inspect
           the corresponding log file for errors. Consult your Red Hat
           representative if any errors are encountered.
           ***These scripts and their corresponding log files need to be
              archived indefinitely.***
   NOTE 2: the dbusername/dppassword@dbSID is determined via:
             grep default_db /etc/rhn/rhn.conf
           And will be of the form: dbusername/dppassword@dbSID

   Ensure you are in the RHN Satellite upgrade directory
      /etc/sysconfig/rhn/satellite-upgrade/

   Determine the schema version of your Satellite by running the following 
   command:
      /usr/bin/rhn-schema-version
      
   The following list is based off the Satellite Schema version determined 
   above, *NOT* the version number of your Satellite.   Please start with the 
   step below that applies to the schema version your Satellite is at 
   currently, and proceed to the very end.

   2.6.*:
      sqlplus dbusername/dbpassword@dbSID @satellite-2.6.0-to-2.7.0.sql
   2.7.*:
      sqlplus dbusername/dbpassword@dbSID @satellite-2.7.0-to-3.2.0.sql
      NOTE: Schema version will be 3.2-4
   3.1.5:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.1.5-to-3.2.0.sql
      NOTE: Schema version will be 3.2-4
   3.2-2:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.2.0-2-to-3.2.0-4.sql
   3.2-4:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.2-to-3.4.sql
   3.4-48:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.4-to-3.6.sql
      NOTE: Schema version will be 3.6-216
   3.6-199:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.6-199-to-3.6-214.sql
   3.6-214:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.6-214-to-3.6-215.sql
   3.6-215:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.6-215-to-3.6-216.sql
   3.6-216:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.6-to-3.7.sql
   3.7-116:
      sqlplus dbusername/dbpassword@dbSID @satellite-3.7-to-4.0.sql
   4.0-214 or 4.0.5-2:
      sqlplus dbusername/dbpassword@dbSID @satellite-4.0-to-4.1.sql
   4.1-45 or 4.1.0-45:
      sqlplus dbusername/dbpassword@dbSID @satellite-4.1-to-4.2.sql
   4.2-4:
      sqlplus dbusername/dbpassword@dbSID @satellite-4.2.0-4-to-4.2.1-2.sql
   4.2.1-2:
      sqlplus dbusername/dbpassword@dbSID @satellite-4.2-to-5.0.sql
   5.0.0-26:
      sqlplus dbusername/dbpassword@dbSID @satellite-5.0-to-5.1.sql

   ** THE FINAL VERSION:
      - run command rhn-schema-version
      - that should match the version as indicated by the SQL upgrade script:
        grep lookup_evr satellite-5.0-to-5.1.sql

   Should this database schema conversion process fail (for example if it 
   runs out of disk space), restore the database from backup, fix the 
   problem, and rerun this step.

10b. Activate the RHN Satellite:
   If this is a connected RHN Satellite (i.e., not disconnected):
      o If the new system is not yet registered to RHN, register it
        with the rhn_register or rhnreg_ks commands.
      o Run:
        rhn-satellite-activate --rhn-cert <ABSOLUTE PATH TO *NEW* RHN CERT>
   If disconnected, run:
      rhn-satellite-activate --rhn-cert <ABSOLUTE PATH TO *NEW* RHN CERT> \
                             --disconnected


11. Redeploy configuration settings:
   a. Change directory (cd) into the upgrade documentation.
   b. /usr/bin/perl rhn-load-config.pl
      NOTE: This script may generate osa configuration errors.  These
            errors may be ignored, as the configuration will be completed
            in the next few steps.

12. Add missing header value:
   NOTE: Only run this when upgrading from 4.1.x or older Satellites. 
   Run the following script to add missing RPM start/end header values:
      python /usr/share/rhn/satellite_tools/satComputePkgHeaders.py \
         --db dbusername/dbpassword@dbSID --prefix=/var/satellite --commit

   NOTE: Running this multiple times will have no ill effect. The duration
   of this operation depends on the number of packages you have in your
   Satellite. You can use the --verbose option to see the progress.

13. Restart services:
   /sbin/service rhn-satellite restart
      NOTE: Because osa-dispatcher is not running at this point, it will fail
            on shutdown.  Also, restarting osa-dispatcher will fail due to
            configuration errors which will be completed in the next few
            steps.  These errors may be ignored.

14. Insert the SSL CA public certificate into the database:
   (making assumption that your ssl-build directory is in /root)
   rhn-ssl-dbstore -vvv --ca-cert /root/ssl-build/RHN-ORG-TRUSTED-SSL-CERT

15. Enable (or re-enable) monitoring and/or push functionality:
   If you would like to enable monitoring, and have not already done so:
      # NOTE: the --enable-scout option will enable the monitoring scout on
      #       your RHN Satellite
      /usr/bin/perl rhn-enable-monitoring.pl --enable-scout

   NOTE: If you were using the technology preview of Monitoring prior to the
   upgrade you will need to do the following once the upgrade is completed.
      a) Login and Push Scout Configs for probes to continue to work:
       - Login to the Satellite Web site
       - Click "Monitoring"
       - Click "Scout Config Push" on left side menu bar
       - Select all configured scouts
       - Click "Push Scout Configs"
      b) Associate previously configured systems with probes with new 
      Monitoring entitlement:
       - Login to the Satellite Web site
       - Click "Systems"
       - Click "System Entitlements"
       - Select from the list of systems you wish to grant Monitoring 
         entitlement
       - Click "Add Monitoring" 

   Enable the push functionality by running this script:
      # *must* have your SSL build directory in /root as /root/ssl-build
      # *must* have your CA SSL public certificate located in your pub/
      #        directory and named as such:
      #          /var/www/html/pub/RHN-ORG-TRUSTED-SSL-CERT
      # Stop RHN Push daemons first, if running. 
      /sbin/service jabberd stop
      /sbin/service osa-dispatcher stop
      /usr/bin/perl rhn-enable-push.pl

16. Verify rhn.conf settings:
   A backup copy of rhn.conf and other configuration files were copied to 
   /etc/sysconfig/rhn/backup-$DATE-$TIME.  Referring to the backup copy of
   the rhn.conf file, please ensure that any previous custom values are set
   in the new RHN Satellite's /etc/rhn/rhn.conf file, such as:

      debug = 3
      pam_auth_service = rhn-satellite

   Restart the Satellite services for the changes within rhn.conf to take
   effect. 
      /sbin/service rhn-satellite restart

17. Test/verify new RHN Satellite:
   website: check that you can log in, that the basic data is sane, and the
            custom RPMs can be downloaded.
            a refresh (Ctrl + R) of the browser could be needed should the
            layout of pages be broken.
            a thorough evaluation (with some depth) is advised
   monitoring: perform steps 13a and 13b (if needed) at this point.
   hosted: ensure the satellite is a satellite according to the hosted site
           (disconnected customers need not do this of course)
   satellite-sync: satellite-sync --list-channels
               or: satellite-sync -m <CHANNEL ISOs DUMPPOINT> --list-channels
                   if disconnected
   client: up2date -l or up2date -u
           ensure existing clients can up2date
           attempt a scheduled action from the new RHN Satellite
   cronjobs: If a cronjob existed for the old satellite, ensure that
             the new RHN Satellite's cronjob is correct
             syntactically. Command line options change over time.
             Test any cronjob strings.

The RHN Satellite should be upgraded and functional now!
===============================================================================

