Upgrading an RHN Proxy Server to version 4.x
-------------------------------------------------------------------------------
$Revision: 1.2 $ $Date: 2005/08/15 19:53:11 $
-------------------------------------------------------------------------------

The process of upgrading an RHN Proxy Server is relatively simple. There are
some complexities involved in some of the steps, but nothing out of the
ordinary. Please note that if you are an RHN Satellite Server customer, that
the RHN Satellite Server must be upgraded to 4.x prior to an upgrade of the
RHN Proxy Server to 4.x.

In the simplest terms an upgrade is as such: 
 
   I. Preparation: Fully back up your RHN Proxy

  II. Reprovision that server to either Red Hat Enterprise Linux 3 or 4 AS, 
      explicitly following the software requirements documentation found in 
      the RHN Proxy Installation Guide. Red Hat Enterprise Linux 4 AS is
      recommended.
 
 III. If applicable, restore the SSL build direction from backup to this
      directory: /root/ssl-build 
      Modernize that SSL build directory to 4.x standards: search for
      "How do I update SSL Keys and Certificates" on Red Hat's Knowledgebase:
      http://kbase.redhat.com/faq/

  IV. Install RHN Proxy Server 4.x via it's top-level parent RHN service:
      either RHN Satellite or RHN hosted.
 
   V. Restore your old RHN Proxy Server's custom package repository to the
      default location of an RHN Proxy Server 4.0: /var/spool/rhn-proxy
      (that's the default, your repo may have been in a different location).
 
  VI. Fully update; bounce services; test!
      up2date -uf
      /sbin/service rhn-proxy stop
      /sbin/service rhn-proxy start
      Test test test!
 

Introductory Notes:
-------------------
 
1. RHN Proxy Server can operate on Red Hat Enterprise Linux 3 or 4 AS. We
   recommend running your RHN Proxy Server on Red Hat Enterprise Linux 4 AS if
   possible.
 
2. RHN Proxy Server can be installed or operated only if connected to RHN
   hosted (xmlrpc.rhn.redhat.com) or an RHN Satellite Server. You can not
   connect an RHN Proxy Server to an earlier version of RHN Satellite Server.
   You have to upgrade your RHN Satellite Server first.
 
3. A "provisioning" entitlement is required for RHN Proxy Server installs
   and upgrades. If you purchased an RHN Proxy Server you will automatically
   receive a provisioning entitlement. For upgrades you will need to make sure
   that you have one available.
 
4. If you are upgrading an RHN Proxy 3.6 or 3.7 Server which is configured as a 
   Monitoring Scout, please be aware that any probes configured against this 
   Scout will be lost during the upgrade process. 
 
I. Preparation:
---------------
 
1. verify you have a working existing RHN Proxy first:
   On the RHN Proxy:
     up2date -uf
     If RHN Proxy version 3.6 (or greater):
         /sbin/service rhn-proxy stop
         /sbin/service rhn-proxy start
     else:
         /sbin/service httpd stop
         /sbin/service squid stop
         /sbin/service squid start
         /sbin/service httpd start
     Additionally if version 1.1.1:
         /sbin/service rhn_auth_cache restart
   On a client connected to that RHN Proxy:
     up2date -l
 
2. make a hard copy of this file for future reference: /etc/rhn/rhn.conf
 
3. completely back up your RHN Proxy Server
 
4. Read the RHN Proxy Installation Guide for software and hardware
   requirements.  The software requirements may differ depending on your
   installation method, either kickstart or from CD.  For instructions on
   using the web interface to perform actions such as provisioning, checking
   entitlements, and others, see the RHN Reference Guide.  The Client
   Configuration Guide contains information on how to connect systems to RHN,
   thus it may be a useful reference.
 
 
II. Reprovision
----------------
 
1. Deactivate the proxy through the RHN web interface. Click on
   System->Details->Proxy and finally 'Deactivate Proxy'

2. You will need to re-install the operating system on the machines in
   question. This can be accomplished either via RHN's provisioning mechanism
   or by installing from an Red Hat Enterprise Linux CD. Regardless of the
   method you choose, follow closely the software requirements specified in
   the RHN Proxy Installation Guide.

3. If you chose the CD Installation method, follow the extra steps below.
   Otherwise continue to step 4.
    
   a) Configure up2date to connect to RHN to mirror the machine's previous 
      configuration.
   b) Register with RHN. Use a re-activation key to ensure that the machine is
      associated with its previous profile.
 

III. Restoring SSL build directory and generating a tar archive
---------------------------------------------------------------

The goal of this section is to refactor your SSL build directory into a format
compatible with RHN v3.7 or better products. A secondary goal is to create an
SSL tar archive to be used during the installation of RHN Proxy 3.7 or better
(RHN hosted connected installs only). In addition to this document, refer to
the Client Configuration Guide for information on using and generating SSL
certificates.

There are several scenarios:

1. Current RHN Proxy is connected to RHN Satellite Server either directly or
   indirectly through a chain of RHN Proxies:

   This entire section III can be skipped as the appropriate SSL keys and
   certificates will be generated and installed during the new installation of
   RHN Proxy Server. I.e., go to section IV.

NOTE: if you have continued, it is assumed you are connecting directly to
      RHN's hosted service or indirectly through a chain of RHN Proxies.

NOTE: If the rhn-ssl-tool is not on your system, you can get it by subscribing
      your system to the Red Hat Network Tools channel and running
      'up2date rhns-certs-tools'.

2. You are upgrading from RHN Proxy Server version 1.1.1
   Refer to:
   http://people.redhat.com/taw/rhn/rhn-ssl-tool/rhn-ssl-update-for-proxy-1.1.1.txt 

   NOTE: references to fetch the build tree from /etc/sysconfig/rhn intends
   for the customer to restore that from backup to /root/ssl-build

4. You are upgrading from RHN Proxy Server version 3.2.0

   a) From the previously created backups, restore /etc/sysconfig/rhn/ssl into
      /root/ssl-build
   b) change directory to /root
   d) Reference the Client Configuration Guide to determine the correct
      parameters to rhn-ssl-tool --gen-ca used in the next step.
   e) run (note the temporary directory):
        rhn-ssl-tool --gen-ca --dir ssl-build-temp <EXTRA OPTIONS>
      Include the parameters from the previous step at the end of the command.
      Enter any bogus password when prompted.
      The point of this step is to generate a new rhn-ca-openssl.cnf.
   f) Copy ssl-build-temp/rhn-ca-openssl.cnf to the current directory.
      Delete ssl-build-temp directory.
   g) use the rhn-ssl-tool to generate a server SSL RPM and tar archive for
      this RHN Proxy:
        rhn-ssl-tool --gen-server
        ^C # i.e., hit control-C at the password prompt
      Move the "unknown" directory just generated to the machine name
      directory: the machine name of that RHN Proxy is determined by
      dropping the domain from the hostname: e.g. my.proxy.example.com's
      machine name is my.proxy
        mv ssl-build/unknown ssl-build/<machine name>
        cd ssl-build/<machine name>
        cat server.crt server.key > server.pem
        cd ../..
        rhn-ssl-tool --gen-server --rpm-only
      If this command is not run on the RHN Proxy, mv the unknown directory
      to the appropriate location and include
        --set-hostname HOSTNAME
   h) Finally, follow the recommendations of the Client Configuration Guide
      for storage of the ssl-build tree.

5. You are upgrading from RHN Proxy Server version 3.2.2
   NOTE: if this RHN Proxy Server was installed as version 3.2.0, follow those
         particular instructions.

   a) From the previously created backups, restore /etc/sysconfig/rhn/ssl into
      /root/ssl-build
      (by "previously created backups" we mean your archive SSL build tree,
       whether it comes from some internal archive repo, local machines,
       whatever)
   b) change directory to /root
   c) use the rhn-ssl-tool to generate a server SSL RPM and tar archive for
      this RHN Proxy:
        cd ssl-build/<machine name>
        cat server.crt server.key > server.pem
        cd ../..
        rhn-ssl-tool --gen-server --rpm-only
      If this command is not run on the RHN Proxy, include
        --set-hostname HOSTNAME
   h) Finally, follow the recommendations of the Client Configuration Guide
      for storage of the ssl-build tree.

6. You are upgrading from RHN Proxy Server version 3.6
   http://kbase.redhat.com/faq/dml_fetch.pl?CompanyID=1&ContentID=1&FaqID=5410
   If that link does not work, go to Red Hat's Knowledgebase and search for
   "SSL Keys and Certificates"
   
   Follow the recommendations of the Client Configuration Guide
   for storage of the ssl-build tree.

If you followed steps 3, 4, 5, or 6 you should now have a tar archive (new for
version 3.7) in the /root/ssl-build/MACHINE-NAME/ directory in this format: 
    rhn-org-httpd-ssl-archive-<MACHINE-NAME>-1.0-RELEASE.tar
 

IV. Install RHN Proxy 4.0
-------------------------
 
Install RHN Proxy Server via it's top-level parent RHN service, which is
either RHN Satellite or RHN hosted. Refer to the Proxy Installation Guide for
instructions.  Use the the hard-copy of /etc/rhn/rhn.conf for values to enter
into the installer (especially traceback_mail, HTTP proxy settings, etc.).
When asked, upload the ssl tar archive created previously (RHN hosted only).
 
 
V. Restore your custom package repository
-----------------------------------------
 
Restore your old RHN Proxy Server's custom package repository to the default
location of an RHN Proxy Server 4.0:

    restore /var/up2date/packages (or /var/spool/rhn-proxy if that applies) to
            /var/spool/rhn-proxy
    chmod 0750 /var/spool/rhn-proxy
    chown apache.apache /var/spool/rhn-proxy
    mkdir -m 0750 -p /var/spool/rhn-proxy/list
    chown apache.apache /var/spool/rhn-proxy/list
 
 
VI. Fully update; bounce services; test!
----------------------------------------
 
up2date -uf
/sbin/service rhn-proxy stop
/sbin/service rhn-proxy start
 
TEST TEST TEST TEST TEST!
 
===============================================================================

