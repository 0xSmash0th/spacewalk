From 950718b522df93786226498c9b355a1c22ccaf76 Mon Sep 17 00:00:00 2001
From: Colin Coe <colin.coe@gmail.com>
Date: Wed, 27 Aug 2008 14:28:03 +0800
Subject: [PATCH] Preserve ks.cfg and any included fragments

---
 .../rhn/domain/kickstart/KickstartData.hbm.xml     |    3 ++-
 .../redhat/rhn/domain/kickstart/KickstartData.java |   19 +++++++++++++++++++
 .../kickstart/KickstartDetailsEditAction.java      |    4 ++++
 .../frontend/strings/jsp/StringResource_en_US.xml  |   14 ++++++++++++++
 .../rhn/manager/kickstart/KickstartFormatter.java  |    7 +++++++
 .../WEB-INF/pages/kickstart/kickstartdetails.jsp   |    4 ++++
 java/code/webapp/WEB-INF/struts-config.xml         |    1 +
 schema/spacewalk/rhnsat/tables/rhnKSData.sql       |    4 ++++
 8 files changed, 55 insertions(+), 1 deletions(-)

diff --git a/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.hbm.xml b/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.hbm.xml
index 5a6f4bc..80e39a3 100644
--- a/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.hbm.xml
+++ b/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.hbm.xml
@@ -21,8 +21,9 @@ PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
         <property name="name" column="name" not-null="true" type="string" length="128" />
         <property name="comments" column="comments"  type="string" length="4000" />
         <property name="active" column="active" not-null="true" type="yes_no" />
-  	    <property name="postLog" column="postLog" not-null="false" type="yes_no" />        
+	    <property name="postLog" column="postLog" not-null="false" type="yes_no" />
 	    <property name="preLog" column="preLog" not-null="false" type="yes_no" />
+            <property name="KsCfg" column="KsCfg" not-null="false" type="yes_no" />
         <property name="created" column="created" not-null="true" type="timestamp" insert="false" update="false"/>
         <property name="modified" column="modified" not-null="true" type="timestamp" insert="false" update="false"/>
         <property name="isOrgDefault" column="is_org_default" not-null="true" type="yes_no" />
diff --git a/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.java b/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.java
index 88ef719..f6f884c 100644
--- a/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.java
+++ b/java/code/src/com/redhat/rhn/domain/kickstart/KickstartData.java
@@ -52,6 +52,7 @@ public class KickstartData {
     private Boolean active;
     private Boolean postLog;
     private Boolean preLog;
+    private Boolean KsCfg;
     private Date created;
     private Date modified;
     private Boolean isOrgDefault;
@@ -979,6 +980,9 @@ public class KickstartData {
         cloned.setLabel(newLabel);
         cloned.setActive(this.getActive());
         cloned.setPostLog(this.getPostLog());
+        cloned.setPreLog(this.getPreLog());
+        cloned.setPreLog(this.getPreLog());
+        cloned.setKsCfg(this.getKsCfg());
         cloned.setComments(this.getComments());
         cloned.setOrg(this.getOrg());
         
@@ -1149,6 +1153,14 @@ public class KickstartData {
     public Boolean getPreLog() {
         return preLog;
     }
+
+    /**
+     * @return Returns if we should copy ks.cfg and %include'd fragments to /root
+     */
+    public Boolean getKsCfg() {
+        return KsCfg;
+    }
+
     
     /**
      * @param postLogIn The postLog to set.
@@ -1164,6 +1176,13 @@ public class KickstartData {
         this.preLog = preLogIn;
     }
 
+     /*
+     * @param KsCfgIn
+     */
+    public void setKsCfg(Boolean KsCfgIn) {
+        this.KsCfg = KsCfgIn;
+    }
+
     
     /**
      * Returns the SE Linux mode associated to this kickstart profile
diff --git a/java/code/src/com/redhat/rhn/frontend/action/kickstart/KickstartDetailsEditAction.java b/java/code/src/com/redhat/rhn/frontend/action/kickstart/KickstartDetailsEditAction.java
index 55d00e8..bf23d03 100644
--- a/java/code/src/com/redhat/rhn/frontend/action/kickstart/KickstartDetailsEditAction.java
+++ b/java/code/src/com/redhat/rhn/frontend/action/kickstart/KickstartDetailsEditAction.java
@@ -42,6 +42,7 @@ public class KickstartDetailsEditAction extends BaseKickstartEditAction {
     public static final String ORG_DEFAULT = "org_default";
     public static final String  POST_LOG = "post_log";
     public static final String  PRE_LOG = "pre_log";
+    public static final String  KS_CFG = "KsCfg";
     
     public static final String VIRTUALIZATION_TYPES = "virtualizationTypes";
     public static final String VIRTUALIZATION_TYPE_LABEL = "virtualizationTypeLabel";
@@ -58,6 +59,7 @@ public class KickstartDetailsEditAction extends BaseKickstartEditAction {
         form.set(ORG_DEFAULT, cmd.getKickstartData().getIsOrgDefault());
         form.set(POST_LOG, cmd.getKickstartData().getPostLog());
         form.set(PRE_LOG, cmd.getKickstartData().getPreLog());
+        form.set(KS_CFG, cmd.getKickstartData().getKsCfg());
 
         // Lookup the kickstart virtualization types and pre-select the current one:
         List types = KickstartFactory.lookupVirtualizationTypes();
@@ -105,6 +107,8 @@ public class KickstartDetailsEditAction extends BaseKickstartEditAction {
                 BooleanUtils.toBoolean((Boolean) form.get(POST_LOG)));
         cmd.getKickstartData().setPreLog(
                 BooleanUtils.toBoolean((Boolean) form.get(PRE_LOG)));
+        cmd.getKickstartData().setKsCfg(
+                BooleanUtils.toBoolean((Boolean) form.get(KS_CFG)));
         
         String virtTypeLabel = form.getString(VIRTUALIZATION_TYPE_LABEL);
         KickstartVirtualizationType ksVirtType = KickstartFactory.
diff --git a/java/code/src/com/redhat/rhn/frontend/strings/jsp/StringResource_en_US.xml b/java/code/src/com/redhat/rhn/frontend/strings/jsp/StringResource_en_US.xml
index 5a0b90d..af6cd49 100644
--- a/java/code/src/com/redhat/rhn/frontend/strings/jsp/StringResource_en_US.xml
+++ b/java/code/src/com/redhat/rhn/frontend/strings/jsp/StringResource_en_US.xml
@@ -8977,6 +8977,20 @@ Please note that some manual configuration of these scripts may still be require
             <context context-type="sourcefile">/rhn/kickstart/KickstartDetailsEdit</context>
         </context-group>
     </trans-unit>
+
+    <trans-unit id="kickstartdetails.jsp.kscfg">
+        <source>Preserve ks.cfg:</source>
+        <context-group name="ctx">
+            <context context-type="sourcefile">/rhn/kickstart/KickstartDetailsEdit</context>
+        </context-group>
+    </trans-unit>
+
+    <trans-unit id="kickstartdetails.jsp.kscfg.msg">
+        <source>If selected, ks.cfg and all %include'd fragments will be copied to /root.</source>
+        <context-group name="ctx">
+            <context context-type="sourcefile">/rhn/kickstart/KickstartDetailsEdit</context>
+        </context-group>
+    </trans-unit>
     
     <trans-unit id="kickstartdetails.jsp.changeos">
         <source>Change</source>
diff --git a/java/code/src/com/redhat/rhn/manager/kickstart/KickstartFormatter.java b/java/code/src/com/redhat/rhn/manager/kickstart/KickstartFormatter.java
index 3c56e16..e10e565 100644
--- a/java/code/src/com/redhat/rhn/manager/kickstart/KickstartFormatter.java
+++ b/java/code/src/com/redhat/rhn/manager/kickstart/KickstartFormatter.java
@@ -85,6 +85,7 @@ public class KickstartFormatter {
     private static final String BEGINRHN = "%post" + NEWLINE + 
     "( # Log %post errors \n # --Begin " + Config.get().getString("web.product_name") +
     " command section--\n";
+    private static final String SAVE_KS_CFG = "cp `awk '{ if ($1 ~ /%include/) {print $2}}' /tmp/ks.cfg` /tmp/ks.cfg /mnt/sysimage/root";
     private static final String END_POST = ") >> /root/ks-post.log 2>&1\n";
     private static final String END_PRE = ") >> /tmp/ks-pre.log 2>&1\n";
     private static final String  BEGIN_PRE_POST_LOG = "(" + NEWLINE;
@@ -504,6 +505,9 @@ public class KickstartFormatter {
                         retval.append(RHN_NOCHROOT);                       
                         seenNoChroot = true;
                     }                    
+                    if (this.ksdata.getKsCfg()) {
+                        retval.append(SAVE_KS_CFG + NEWLINE);
+                    }
                     retval.append(kss.getDataContents() + NEWLINE);
                     
                 }
@@ -514,6 +518,9 @@ public class KickstartFormatter {
         if (!seenNoChroot) {
             retval.append("%" + KickstartScript.TYPE_POST + SPACE + NOCHROOT + NEWLINE);
             retval.append(RHN_NOCHROOT);
+            if (this.ksdata.getKsCfg()) {
+                retval.append(SAVE_KS_CFG + NEWLINE);
+            }
         }
         
         return retval.toString();
diff --git a/java/code/webapp/WEB-INF/pages/kickstart/kickstartdetails.jsp b/java/code/webapp/WEB-INF/pages/kickstart/kickstartdetails.jsp
index 21937ba..9b18281 100644
--- a/java/code/webapp/WEB-INF/pages/kickstart/kickstartdetails.jsp
+++ b/java/code/webapp/WEB-INF/pages/kickstart/kickstartdetails.jsp
@@ -71,6 +71,10 @@
             <td><table><tr><td><html:checkbox property="pre_log" /></td><td><bean:message key="kickstartdetails.jsp.prelog.msg"  /></td></tr></table></td>
           </tr>
           <tr>
+            <th><bean:message key="kickstartdetails.jsp.kscfg"/></th>
+            <td><table><tr><td><html:checkbox property="KsCfg" /></td><td><bean:message key="kickstartdetails.jsp.kscfg.msg"  /></td></tr></table></td>
+          </tr>
+          <tr>
             <th><bean:message key="kickstartdetails.jsp.org_default" /></th>
             <td><table><tr><td><html:checkbox property="org_default" /></td><td><bean:message key="kickstartdetails.jsp.summary2" arg0="${ksurl}" /></td></tr></table></td>
           </tr>
diff --git a/java/code/webapp/WEB-INF/struts-config.xml b/java/code/webapp/WEB-INF/struts-config.xml
index fc0e859..af08ef6 100644
--- a/java/code/webapp/WEB-INF/struts-config.xml
+++ b/java/code/webapp/WEB-INF/struts-config.xml
@@ -555,6 +555,7 @@
             <form-property name="active" type="java.lang.Boolean" />
            <form-property name="post_log" type="java.lang.Boolean" />
            <form-property name="pre_log" type="java.lang.Boolean" />
+            <form-property name="KsCfg" type="java.lang.Boolean" />
             <form-property name="org_default" type="java.lang.Boolean" />
             <form-property name="comments" type="java.lang.String" /> 
             <form-property name="submitted"  type="java.lang.Boolean"/>
diff --git a/schema/spacewalk/rhnsat/tables/rhnKSData.sql b/schema/spacewalk/rhnsat/tables/rhnKSData.sql
index c2e5cdb..43512df 100644
--- a/schema/spacewalk/rhnsat/tables/rhnKSData.sql
+++ b/schema/spacewalk/rhnsat/tables/rhnKSData.sql
@@ -51,6 +51,10 @@ rhnKSData
                 constraint rhn_ks_pre_log_nn not null
                 constraint rhn_ks_pre_log_ck
                     check (preLog in ('Y','N')),
+    kscfg      char(1) default('N')
+                constraint rhn_ks_cfg_save_nn not null
+                constraint rhn_ks_cfg_save_ck
+                    check (kscfg in ('Y','N')),
 	pre			blob,
 	post			blob,
         nochroot_post           blob,
-- 
1.5.5.1

