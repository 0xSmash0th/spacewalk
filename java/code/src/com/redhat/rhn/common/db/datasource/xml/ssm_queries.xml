<datasource_modes>

<write-mode name="subscribe_server_channels_in_set">
   <query>
      INSERT INTO rhnServerChannel (server_id, channel_id)
                  (
                  SELECT element, element_two
                    FROM rhnSet
                   WHERE label = 'ssm_channel_subscribe'
                  )
   </query>
</write-mode>

<write-mode name="log_subscribe_server_channels_in_set">
   <query>
      INSERT INTO rhnServerHistory (id, server_id, summary)
                  (
                  SELECT rhn_event_id_seq.nextval,
                         s.element,
                         'subscribed to channel ' || (SELECT label FROM rhnChannel c WHERE c.id = s.element_two)
                    FROM rhnSet s
                   WHERE s.label = 'ssm_channel_subscribe'
                  )
   </query>
</write-mode>

<write-mode name="unsubscribe_server_channels_in_set">
   <query>
      DELETE FROM rhnServerChannel
            WHERE (server_id, channel_id)
               IN (SELECT element, element_two
                     FROM rhnSet s
                    WHERE s.label = 'ssm_channel_unsubscribe')
   </query>
</write-mode>

<write-mode name="log_unsubscribe_server_channels_in_set">
   <query>
      INSERT INTO rhnServerHistory (id, server_id, summary)
                  (
                  SELECT rhn_event_id_seq.nextval,
                         s.element,
                         'unsubscribed from channel ' || (SELECT label FROM rhnChannel c WHERE c.id = s.element_two)
                    FROM rhnSet s
                   WHERE s.label = 'ssm_channel_unsubscribe'
                  )
   </query>
</write-mode>
   
<write-mode name="flag_server_channels_changed_in_set">
   <query params="set_label">
      UPDATE rhnServer
         SET channels_changed = sysdate
       WHERE id
          IN (SELECT element
                FROM rhnSet
               WHERE label = :set_label)
   </query>
</write-mode>
   
   

</datasource_modes>