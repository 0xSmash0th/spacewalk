<datasource_modes>

  <mode name="packages_needing_updates"
    class="com.redhat.rhn.frontend.dto.ErrataCacheDto">
    <query params="server_id">
select snpc.server_id, snpc.org_id, snpc.errata_id, snpc.package_id
  from rhnServerNeededPackageCache snpc,
       rhnpackage p
 where server_id = :server_id
   and p.id = package_id
    </query>
  </mode>

  <mode name="errata_needing_application"
    class="com.redhat.rhn.frontend.dto.ErrataCacheDto">
    <query params="server_id">
select server_id, org_id, errata_id
  from rhnServerNeededErrataCache
 where server_id = :server_id
  </query>
</mode>

<mode name="new_packages"
    class="com.redhat.rhn.frontend.dto.ErrataCacheDto">
 <query params="server_id">
select server_id, org_id, errata_id, package_id
  from rhnServerNeededPackageView
 where server_id = :server_id
   </query>
</mode>

<mode name="verify_errata_cache_contents">
	<query params="org_id, errata_id">
select count(server_id) 
from rhnServerNeededErrataCache 
where org_id = :org_id and errata_id = :errataId
	</query>
</mode>
  
<write-mode name="insert_needed_package_cache">
  <query params="server_id, org_id, errata_id, package_id">
INSERT INTO rhnServerNeededPackageCache
            (server_id, org_id, errata_id, package_id)
     VALUES (:server_id, :org_id, :errata_id, :package_id)
  </query>
</write-mode>

<write-mode name="delete_needed_package_cache">
  <query params="server_id, org_id, errata_id, package_id">
DELETE FROM rhnServerNeededPackageCache
      WHERE server_id = :server_id
        AND org_id = :org_id
        AND errata_id = :errata_id
        AND package_id = :package_id
  </query>
</write-mode>

<write-mode name="delete_needed_package_cache_null_errata">
  <query params="server_id, org_id, package_id">
DELETE FROM rhnServerNeededPackageCache
      WHERE server_id = :server_id
        AND org_id = :org_id
        AND errata_id IS NULL
        AND package_id = :package_id
  </query>
</write-mode>

<write-mode name="insert_needed_errata_cache">
  <query params="server_id, org_id, errata_id">
INSERT INTO rhnServerNeededErrataCache
            (server_id, org_id, errata_id)
     VALUES (:server_id, :org_id, :errata_id)
  </query>
</write-mode>

<write-mode name="delete_needed_errata_cache">
  <query params="server_id, org_id, errata_id">
DELETE FROM rhnServerNeededErrataCache
      WHERE server_id = :server_id
        AND org_id = :org_id
        AND errata_id = :errata_id
  </query>
</write-mode>

<mode name="count_servers_in_errata_cache_queue">
  <query params="org_id">
SELECT server_count as num_items
  FROM rhnOrgErrataCacheQueue
 WHERE org_id = :org_id
   AND processed = 0
  </query>
</mode>

<mode name="all_serverids_for_org">
  <query params="org_id">
SELECT id FROM rhnServer WHERE org_id = :org_id
  </query>
</mode>

<write-mode name="delete_errata_cache_queue">
  <query params="org_id">
DELETE FROM rhnOrgErrataCacheQueue WHERE org_id = :org_id
  </query>
</write-mode>

<write-mode name="delete_package_cache_by_channel">
  <query params="channel_id">
DELETE FROM rhnServerNeededPackageCache PC
WHERE PC.server_id in 
    (SELECT server_id from rhnServerChannel SC where SC.channel_id = :channel_id)
  </query>
</write-mode>

<write-mode name="delete_errata_cache_by_channel">
  <query params="channel_id">
DELETE FROM rhnServerNeededErrataCache EC
WHERE EC.server_id in 
    (SELECT server_id from rhnServerChannel SC where SC.channel_id = :channel_id)
  </query>
</write-mode>

<write-mode name="insert_package_cache_by_channel">
  <query params="channel_id">
INSERT INTO rhnServerNeededPackageCache (org_id, server_id, errata_id, package_id)
(SELECT   S.org_id,
         S.id,
      (SELECT EP.errata_id
         FROM rhnErrataPackage EP,
              rhnChannelErrata CE,
          rhnServerChannel SC
        WHERE SC.server_id = S.id
          AND SC.channel_id = CE.channel_id
          AND CE.errata_id = EP.errata_id
          AND EP.package_id = P.id
          AND ROWNUM = 1) AS errata_id,
     P.id
FROM
     rhnPackage P,
     rhnServerPackageArchCompat SPAC,
     rhnPackageEVR P_EVR,
     rhnPackageEVR SP_EVR,
     rhnServerPackage SP,
     rhnChannelPackage CP,
     rhnServerChannel SC,
         rhnServer S
WHERE
         SC.server_id = S.id
  AND    SC.channel_id = CP.channel_id
  AND    CP.package_id = P.id
  AND    p.package_arch_id = spac.package_arch_id
  AND    spac.server_arch_id = s.server_arch_id
  AND    SP_EVR.id = SP.evr_id
  AND    P_EVR.id = P.evr_id
  AND    SP.server_id = S.id
  AND    SP.name_id = P.name_id
  AND    SP.evr_id != P.evr_id
  AND    SP_EVR.evr &lt; P_EVR.evr
  AND    SP_EVR.evr = (SELECT MAX(PE.evr) FROM rhnServerPackage SP2, rhnPackageEvr PE 
                       WHERE PE.id = SP2.evr_id AND SP2.server_id = SP.server_id 
                       AND SP2.name_id = SP.name_id)
  AND    SC.channel_id = :channel_id)
  </query>
</write-mode>


<write-mode name="insert_errata_cache_by_channel">
  <query params="channel_id">

INSERT INTO rhnServerNeededErrataCache (org_id, server_id, errata_id)
(SELECT DISTINCT S.org_id,
     S.id as server_id,
     ep.errata_id as errata_id
FROM
     rhnPackage P,
     rhnServerPackageArchCompat SPAC,
     rhnPackageEVR P_EVR,
     rhnPackageEVR SP_EVR,
     rhnServerPackage SP,
     rhnChannelPackage CP,
     rhnServerChannel SC,
     rhnServer S,
     rhnChannelErrata CE,
     rhnErrataPackage EP
WHERE
         SC.server_id = S.id
  AND    EP.package_id = P.id
  AND    EP.errata_id = CE.errata_id
  AND    CE.channel_id = SC.channel_id
  AND    SC.channel_id = CP.channel_id
  AND    CP.package_id = P.id
  AND    p.package_arch_id = spac.package_arch_id
  AND    spac.server_arch_id = s.server_arch_id
  AND    SP_EVR.id = SP.evr_id
  AND    P_EVR.id = P.evr_id
  AND    SP.server_id = S.id
  AND    SP.name_id = P.name_id
  AND    SP.evr_id != P.evr_id
  AND    SP_EVR.evr &lt; P_EVR.evr
  AND    SP_EVR.evr = (SELECT MAX(PE.evr) FROM 
  rhnServerPackage SP2, rhnPackageEvr PE WHERE PE.id = SP2.evr_id 
    AND SP2.server_id = SP.server_id AND SP2.name_id = SP.name_id)
  AND sc.channel_id = :channel_id)

  </query>
</write-mode>



</datasource_modes>