<?xml version="1.0"?>
                                                                              
<project name="build-webapp">

    <!-- =================== Deployment Tasks ======================= -->

    <!-- Removes all web applications defined in webapps -->
    <target name="remove" depends="init-taskdefs">
        <foreach list="${rhnapp}" target="remove-webapp" param="webapp" />
    </target>

    <!-- Deploys all web applications defined in webapps -->
    <target name="deploy" depends="init-taskdefs">
        <foreach list="${rhnapp}" target="deploy-webapp" param="webapp" />
    </target>

    <!-- Reloads all web applications defined in webapps -->
    <target name="reload" depends="init-taskdefs">
        <foreach list="${rhnapp}" target="reload-webapp" param="webapp" />
    </target>

    <!-- starts all web applications defined in webapps -->
    <target name="start" depends="init-taskdefs">
        <foreach list="${rhnapp}" target="start-webapp" param="webapp" />
    </target>

    <!-- stops all web applications defined in webapps -->
    <target name="stop" depends="init-taskdefs">
        <foreach list="${rhnapp}" target="stop-webapp" param="webapp" />
    </target>

    <!-- Lists webapps -->
    <target name="list" depends="init-taskdefs">
        <list url="http://${catalina.hostname}:${catalina.port}/manager"
                username="${catalina.username}"
                password="${catalina.password}" />
    </target>

    <!-- Deploys the web application defined by webapp-->
    <target name="deploy-webapp" if="webapp">
        <deploy url="http://${catalina.hostname}:${catalina.port}/manager"
                username="${catalina.username}"
                password="${catalina.password}"
                path="/${webapp}"
                war="file:${build.dir}/webapp/${webapp}.war" />
    </target>

    <!-- Reloads the web application defined by webapp-->
    <target name="reload-webapp" if="webapp">
        <reload url="http://${catalina.hostname}:${catalina.port}/manager"
                username="${catalina.username}"
                password="${catalina.password}"
                path="/${webapp}" />
    </target>

    <!-- Start the web application defined by webapp-->
    <target name="start-webapp" if="webapp">
        <start url="http://${catalina.hostname}:${catalina.port}/manager"
                username="${catalina.username}"
                password="${catalina.password}"
                path="/${webapp}" />
    </target>

    <!-- Stop the web application defined by webapp-->
    <target name="stop-webapp" if="webapp">
        <stop url="http://${catalina.hostname}:${catalina.port}/manager"
                username="${catalina.username}"
                password="${catalina.password}"
                path="/${webapp}" />
    </target>

    <!-- Removes the web application defined by webapp-->
    <target name="remove-webapp" if="webapp">
        <remove url="http://${catalina.hostname}:${catalina.port}/manager"
                username="${catalina.username}"
                password="${catalina.password}" 
                path="/${webapp}" />
    </target>


    <!-- ================ Local Deployment Tasks ==================== -->
    <!--
      - Creates a local web application structure easily reloadable in
      - Tomcat.
      -->

    <target name="clean-webapp-dir"
      description="Cleans up the web application directory.">
        <!--
          - cleanup the directory first, we can not use
          - the delete target because it follows the symlinks
          - deleting way more than we want.  And we can't use
          - "symlink action="delete" because we don't have the 
          - actualy symlink name since they are being auto
          - generated by the for target.
          -->
        <exec executable="rm" os="Linux" dir="${webapp.basedir}">
            <arg value="-rf"/>
            <arg value="${webapp.name}"/>
        </exec>
    </target>

    <target name="create-webapp-dir" depends="init-taskdefs,clean-webapp-dir,apidoc-jsp"
      description="Creates a local web application structure easily reloadable in Tomcat.">

        <!-- Setup directories that can not be symlinked -->
        <!-- Also creates WEB-INF -->
        <mkdir dir="${webapp.dir}" />
        <mkdir dir="${webapp.dir}/META-INF" />
        <mkdir dir="${webapp.dir}/WEB-INF/lib" />
        <mkdir dir="${webapp.dir}/apidoc" />

     
        <!--
          - The for task takes each item in the fileset placing
          - it in the jspfiles parameter.  Then it calls the
          - tasks within the sequential block.
          -->
        <for param="jspfiles">
            <path>
                <fileset dir="${src.dir}/webapp" includes="*.jsp" />
            </path>
            <sequential>
               <symlink failonerror="false" link="${webapp.dir}" 
                        resource="@{jspfiles}"/>
            </sequential>
        </for>

        <for param="xmlfiles">
            <path>
                <fileset dir="${src.dir}/webapp/WEB-INF">
                    <include name="*.xml" />
                    <include name="*.wsdd" />
                </fileset>
            </path>
            <sequential>
               <symlink failonerror="false" link="${webapp.dir}/WEB-INF" 
                        resource="@{xmlfiles}"/>
            </sequential>
        </for>

        <for param="externaljar">
            <path>
                <fileset dir="${run-external.lib.dir}">
                    <!--
                      - We need to keep the Oracle drivers
                      - out of the WEB-INF/lib directory.
                      - Otherwise, we run into JNI issues
                      - when reloading webapps.
                      - Alternatively, we could use the 
                      - thin driver. :)
                      -->
                    <exclude name="**/oracle-jdbc*" />
                    <exclude name="**/servlet*" />
                </fileset>
            </path>
            <sequential>
               <symlink link="${webapp.dir}/WEB-INF/lib" 
                        resource="@{externaljar}"/>
            </sequential>
        </for>
	
        <for param="apidoc">
	   <path>
              <dirset dir="${report.dir}/apidocs/jsp/handlers/" />
           </path>
            <sequential>
               <symlink link="${webapp.dir}/apidoc/" 
                        resource="@{apidoc}"/>
            </sequential>
        </for>

        <for param="apidoc">
           <fileset dir="${report.dir}/apidocs/jsp/" includes="*.jsp" />
            <sequential>
               <symlink link="${webapp.dir}/apidoc/" 
                        resource="@{apidoc}"/>
            </sequential>
        </for>

        <symlink overwrite="true" link="${webapp.dir}/newlogin" 
                 resource="${src.dir}/webapp/newlogin"/>
        <symlink overwrite="true" link="${webapp.dir}/help" 
                 resource="${src.dir}/webapp/help"/>

        <!-- symlink link resource = ln -s resource link -->

        <symlink overwrite="true" link="${webapp.dir}/css" 
                 resource="${src.dir}/webapp/css"/>
        <symlink overwrite="true" link="${webapp.dir}/users" 
                 resource="${src.dir}/webapp/users"/>
        <symlink overwrite="true" link="${webapp.dir}/errata" 
                 resource="${src.dir}/webapp/errata"/>
        <symlink overwrite="true" link="${webapp.dir}/systems" 
                 resource="${src.dir}/webapp/systems"/>
        <symlink overwrite="true" link="${webapp.dir}/schedule" 
                 resource="${src.dir}/webapp/schedule"/>
        <symlink overwrite="true" link="${webapp.dir}/errors"
                 resource="${src.dir}/webapp/errors"/>
        <symlink overwrite="true" link="${webapp.dir}/WEB-INF/pages" 
                 resource="${src.dir}/webapp/WEB-INF/pages"/>
        <symlink overwrite="true" link="${webapp.dir}/WEB-INF/decorators" 
                 resource="${src.dir}/webapp/WEB-INF/decorators"/>
        <symlink overwrite="true" link="${webapp.dir}/WEB-INF/includes" 
                 resource="${src.dir}/webapp/WEB-INF/includes"/>
        <symlink overwrite="true" link="${webapp.dir}/WEB-INF/classes" 
                 resource="${build.dir}/classes"/>
        <symlink overwrite="true" link="${webapp.dir}/WEB-INF/nav" 
                 resource="${src.dir}/webapp/WEB-INF/nav"/>

    </target>

</project>
