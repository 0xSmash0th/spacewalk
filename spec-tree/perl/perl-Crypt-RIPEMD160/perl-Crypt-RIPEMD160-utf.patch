--- Crypt-RIPEMD160-0.04/RIPEMD160.xs.utf8	2002-09-11 16:17:54.000000000 -0400
+++ Crypt-RIPEMD160-0.04/RIPEMD160.xs	2002-09-11 16:18:43.000000000 -0400
@@ -14,6 +14,25 @@
 
 #include "wrap_160.h"
 
+#ifdef SvPVbyte
+   #if PERL_REVISION == 5 && PERL_VERSION < 7
+       /* SvPVbyte does not work in perl-5.6.1, borrowed version for 5.7.3 */
+       #undef SvPVbyte
+       #define SvPVbyte(sv, lp) \
+          ((SvFLAGS(sv) & (SVf_POK|SVf_UTF8)) == (SVf_POK) \
+           ? ((lp = SvCUR(sv)), SvPVX(sv)) : my_sv_2pvbyte(aTHX_ sv, &lp))
+
+       static char *
+       my_sv_2pvbyte(pTHX_ register SV *sv, STRLEN *lp)
+       {
+           sv_utf8_downgrade(sv,0);
+           return SvPV(sv,*lp);
+       }
+   #endif
+#else
+   #define SvPVbyte SvPV
+#endif
+
 MODULE = Crypt::RIPEMD160	PACKAGE = Crypt::RIPEMD160	PREFIX = rmd160_
 
 PROTOTYPES: DISABLE
@@ -58,7 +77,7 @@
 	    int i;
 
 	    for (i = 1; i < items; i++) {
-		strptr = (byte *) (SvPV(ST(i), len));
+		strptr = (byte *) (SvPVbyte(ST(i), len));
 		RIPEMD160_update(ripemd160, strptr, len);
 	    }
 	}
