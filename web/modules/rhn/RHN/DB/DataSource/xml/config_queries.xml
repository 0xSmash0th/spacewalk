<datasource_modes>

<mode name="system_managed_config_latest_revisions">
  <query params="sid">
SELECT DISTINCT CF.latest_config_revision_id,
                CFN.path,
                CF.id
  FROM rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnServerConfigChannel SCC
 WHERE SCC.server_id = :sid
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.config_file_name_id = CFN.id
  </query>
</mode>

<mode name="latest_files_in_namespace">
  <query params="ccid">
SELECT CR.id, CFN.path, CR.revision, CCon.file_size,
       TO_CHAR(CCon.modified, 'YYYY-MM-DD HH24:MI:SS') AS MODIFIED,
       CFT.name AS FILETYPE
  FROM rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnConfigChannel CC,
       rhnConfigFileType CFT
 WHERE CC.id = :ccid
   AND CF.config_channel_id = CC.id
   AND CFN.id = CF.config_file_name_id
   AND CR.config_file_id = CF.id
   AND CR.config_content_id = CCon.id
   AND CF.latest_config_revision_id = CR.id
   AND CR.config_file_type_id = CFT.id
ORDER BY CFN.path
  </query>
</mode>

<mode name="selected_files">
  <query params="user_id">
SELECT CR.id, CFN.path, CR.revision,
       TO_CHAR(CCon.modified, 'YYYY-MM-DD HH24:MI:SS') AS MODIFIED,
       CFT.name AS FILETYPE
  FROM rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnSet S,
       rhnConfigFileType CFT
 WHERE CR.id = S.element
   AND S.user_id = :user_id
   AND S.label = 'selected_files'
   AND CFN.id = CF.config_file_name_id
   AND CR.config_file_id = CF.id
   AND CR.config_content_id = CCon.id
   AND CF.latest_config_revision_id = CR.id
   AND CR.config_file_type_id = CFT.id
ORDER BY CFN.path
  </query>
</mode>

<mode name="files_in_sandbox">
  <query params="sid">
SELECT CR.id,
       CFN.path,
       CR.revision,
       TO_CHAR(CCon.modified, 'YYYY-MM-DD HH24:MI:SS') AS CONTENTS_MODIFIED,
       TO_CHAR(CF.modified, 'YYYY-MM-DD HH24:MI:SS') AS UPLOADED_AT,
       NVL2(CCon.contents, DECODE(CCon.is_binary, 'Y', 'binary', 'text'), 'meta-data only') AS CONTENT_TYPE
  FROM rhnConfigInfo CI,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnConfigChannel CC,
       rhnServerConfigChannel SCC
 WHERE CC.confchan_type_id = (SELECT id FROM rhnConfigChannelType WHERE label = 'server_import')
   AND SCC.server_id = :sid
   AND SCC.config_channel_id = CC.id
   AND CF.config_channel_id = CC.id
   AND CFN.id = CF.config_file_name_id
   AND CR.config_file_id = CF.id
   AND CR.config_content_id = CCon.id
   AND CR.config_info_id = CI.id
   AND CF.latest_config_revision_id = CR.id
ORDER BY CFN.path
  </query>
</mode>

<mode name="files_in_override">
  <query params="sid">
SELECT CR.id, CFN.path, CR.revision,
       TO_CHAR(CCon.modified, 'YYYY-MM-DD HH24:MI:SS') AS MODIFIED,
       CFT.name AS FILETYPE
  FROM rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnConfigChannel CC,
       rhnServerConfigChannel SCC,
       rhnConfigFileType CFT
 WHERE CC.confchan_type_id = (SELECT id FROM rhnConfigChannelType WHERE label = 'local_override')
   AND SCC.server_id = :sid
   AND SCC.config_channel_id = CC.id
   AND CF.config_channel_id = CC.id
   AND CFN.id = CF.config_file_name_id
   AND CR.config_file_id = CF.id
   AND CR.config_content_id = CCon.id
   AND CF.latest_config_revision_id = CR.id
   AND CR.config_file_type_id = CFT.id
ORDER BY CFN.path
  </query>
</mode>

<mode name="configfile_revisions">
  <query params="crid">
SELECT CR.id,
       Csum.checksum md5sum,
       CR.revision,
       NVL2((SELECT 1 FROM rhnConfigFile CFt WHERE CFT.latest_config_revision_id = CR.id), 'Y', 'N') LATEST,
       TO_CHAR(CCon.created, 'YYYY-MM-DD HH24:MI:SS') AS CREATED
  FROM rhnConfigContent CCon, rhnConfigRevision CR, rhnConfigFile CF,
       rhnChecksum Csum
 WHERE CCon.id = CR.config_content_id
   AND CF.id = (SELECT config_file_id FROM rhnConfigRevision WHERE id = :crid)
   AND CF.id = CR.config_file_id
   AND CCon.checksum_id = Csum.id
ORDER BY CR.revision DESC
  </query>
</mode>

<mode name="configfiles_for_system">
  <query params="sid">
SELECT CR.id AS ID,
       Csum.checksum md5sum,
       CFN.path,
       CR.revision,
       NVL2((SELECT 1 FROM rhnConfigFile CFt WHERE CFT.latest_config_revision_id = CR.id), 'Y', 'N') LATEST,
       TO_CHAR(CCon.created, 'YYYY-MM-DD HH24:MI:SS') AS CREATED,
       CASE CCT.label WHEN 'local_override' THEN '(system override)' ELSE CC.name END AS CONFIG_CHANNEL_NAME,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID,
       SCC.position AS RANK,
       CFN.id as CONFIG_FILE_NAME_ID,
       CCT.label as type,
       CCT.priority as type_priority,
       CFT.name as FILETYPE
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC,
       rhnConfigFileType CFT,
       rhnChecksum Csum
 WHERE SCC.server_id = :sid
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
   AND CR.config_file_type_id = CFT.id
   AND CCon.checksum_id = Csum.id
ORDER BY CCT.priority, SCC.position
  </query>
  <elaborator params="sid" multiple="t">
SELECT DISTINCT CR_orig.id AS ID,
       CR.id AS CRID,
       CR.revision,
       CC.name AS CONFIG_CHANNEL,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID,
       SCC.position AS RANK
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigFile CF_Orig,
       rhnConfigFile CF,
       rhnConfigRevision CR_orig,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC
 WHERE 1=1
   AND SCC.server_id = :sid
   AND SCC.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCT.label in ('normal', 'local_override')
   AND SCC.config_channel_id = CF.config_channel_id
   AND CR_orig.id IN (%s)
   AND CF.config_channel_id != CF_orig.config_channel_id
   AND CF.config_file_name_id = CF_orig.config_file_name_id
   AND CF.latest_config_revision_id = CR.id
   AND CF.id = CR.config_file_id
   AND CF_Orig.id = CR_Orig.config_file_id
ORDER BY SCC.position
  </elaborator>
</mode>

<mode name="configfiles_for_system_diff">
  <query params="sid">
SELECT CR.id AS ID,
       Csum.checksum md5sum,
       CFN.path,
       CR.revision,
       NVL2((SELECT 1 FROM rhnConfigFile CFt WHERE CFT.latest_config_revision_id = CR.id), 'Y', 'N') LATEST,
       TO_CHAR(CCon.created, 'YYYY-MM-DD HH24:MI:SS') AS CREATED,
       CASE CCT.label WHEN 'local_override' THEN '(system override)' ELSE CC.name END AS CONFIG_CHANNEL_NAME,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID,
       SCC.position AS RANK,
       CFN.id as CONFIG_FILE_NAME_ID,
       CCT.label as type,
       CCT.priority as type_priority,
       CFT.name as FILETYPE
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC,
       rhnConfigFileType CFT,
       rhnChecksum Csum
 WHERE SCC.server_id = :sid
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
   AND CR.config_file_type_id = CFT.id
   AND NOT CFT.label = 'directory'
   AND CCon.checksum_id = Csum.id
ORDER BY CCT.priority, SCC.position
  </query>
  <elaborator params="sid" multiple="t">
SELECT DISTINCT CR_orig.id AS ID,
       CR.id AS CRID,
       CR.revision,
       CC.name AS CONFIG_CHANNEL,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID,
       SCC.position AS RANK
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigFile CF_Orig,
       rhnConfigFile CF,
       rhnConfigRevision CR_orig,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC
 WHERE 1=1
   AND SCC.server_id = :sid
   AND SCC.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCT.label in ('normal', 'local_override')
   AND SCC.config_channel_id = CF.config_channel_id
   AND CR_orig.id IN (%s)
   AND CF.config_channel_id != CF_orig.config_channel_id
   AND CF.config_file_name_id = CF_orig.config_file_name_id
   AND CF.latest_config_revision_id = CR.id
   AND CF.id = CR.config_file_id
   AND CF_Orig.id = CR_Orig.config_file_id
ORDER BY SCC.position
  </elaborator>
</mode>

<mode name="ssm_configfile_revisions">
  <query params="user_id">
SELECT SCC.server_id,
       CR.id AS ID,
       Csum.checksum md5sum,
       CFN.path,
       CR.revision,
       NVL2((SELECT 1 FROM rhnConfigFile CFt WHERE CFT.latest_config_revision_id = CR.id), 'Y', 'N') LATEST,
       TO_CHAR(CCon.created, 'YYYY-MM-DD HH24:MI:SS') AS CREATED,
       CASE CCT.label WHEN 'local_override' THEN '(system override)' ELSE CC.name END AS CONFIG_CHANNEL_NAME,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID,
       SCC.position AS RANK,
       CFN.id as CONFIG_FILE_NAME_ID,
       CCT.label as type,
       CCT.priority as type_priority
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC,
       rhnChecksum Csum
 WHERE SCC.server_id IN (
    SELECT DISTINCT S.id
      FROM rhnServer S,
           rhnSet ST,
           rhnUserServerPerms USP
     WHERE USP.user_id = :user_id
       AND ST.user_id = :user_id
       AND ST.label = 'system_list'
       AND USP.server_id = ST.element
       AND rhn_server.system_service_level(USP.server_id, 'provisioning') > 0
       AND USP.server_id = S.id
   )
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
   AND CFN.id IN (
     SELECT element 
       FROM rhnSet 
     WHERE label = 'selected_configfiles_ssm' 
       AND USER_ID = :user_id
   )
   AND CCon.checksum_id = Csum.id
   ORDER BY SCC.server_id, CCT.priority, SCC.position
  </query>
</mode>


<mode name="configfiles_for_ssm">
  <query params="user_id">
SELECT DISTINCT CFN.id, CFN.path, CF.ID AS cfid, CFT.name as TYPE
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC,
       rhnConfigFileType CFT
 WHERE 1=1
    AND SCC.server_id IN (
      SELECT DISTINCT S.id
        FROM rhnServer S,
             rhnSet ST,
             rhnUserServerPerms USP
       WHERE USP.user_id = :user_id
         AND ST.user_id = :user_id
         AND ST.label = 'system_list'
         AND USP.server_id = ST.element
         AND rhn_server.system_service_level(USP.server_id, 'provisioning') > 0
         AND USP.server_id = S.id
   )
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
   AND CR.config_file_type_id = CFT.id
ORDER BY CFN.path
  </query>
 <elaborator params="user_id">
SELECT CFN.id, count(DISTINCT SCC.server_id) AS system_count
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC
 WHERE 1=1
    AND SCC.server_id IN (
      SELECT DISTINCT S.id
        FROM rhnServer S,
             rhnSet ST,
             rhnUserServerPerms USP
       WHERE USP.user_id = :user_id
         AND ST.user_id = :user_id
         AND ST.label = 'system_list'
         AND USP.server_id = ST.element
         AND rhn_server.system_service_level(USP.server_id, 'provisioning') > 0
         AND USP.server_id = S.id
   )
   AND CFN.id IN (%s)
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
 GROUP BY CFN.id
 </elaborator>
</mode>

<mode name="configfiles_for_ssm_diff">
  <query params="user_id">
SELECT DISTINCT CFN.id, CFN.path, CF.ID AS cfid, CFT.name as TYPE
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC,
       rhnConfigFileType CFT
 WHERE 1=1
    AND SCC.server_id IN (
      SELECT DISTINCT S.id
        FROM rhnServer S,
             rhnSet ST,
             rhnUserServerPerms USP
       WHERE USP.user_id = :user_id
         AND ST.user_id = :user_id
         AND ST.label = 'system_list'
         AND USP.server_id = ST.element
         AND rhn_server.system_service_level(USP.server_id, 'provisioning') > 0
         AND USP.server_id = S.id
   )
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
   AND CR.config_file_type_id = CFT.id
   AND NOT CFT.label = 'directory'
ORDER BY CFN.path
  </query>
 <elaborator params="user_id">
SELECT CFN.id, count(DISTINCT SCC.server_id) AS system_count
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnServerConfigChannel SCC
 WHERE 1=1
    AND SCC.server_id IN (
      SELECT DISTINCT S.id
        FROM rhnServer S,
             rhnSet ST,
             rhnUserServerPerms USP
       WHERE USP.user_id = :user_id
         AND ST.user_id = :user_id
         AND ST.label = 'system_list'
         AND USP.server_id = ST.element
         AND rhn_server.system_service_level(USP.server_id, 'provisioning') > 0
         AND USP.server_id = S.id
   )
   AND CFN.id IN (%s)
   AND SCC.config_channel_id = CF.config_channel_id
   AND CF.id = CR.config_file_id
   AND CF.config_file_name_id = CFN.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CF.latest_config_revision_id = CR.id
   AND CCT.label in ('normal', 'local_override')
 GROUP BY CFN.id
 </elaborator>
</mode>

<mode name="selected_configfiles">
  <query params="set_label, user_id">
SELECT CR.id,
       Csum.checksum md5sum,
       CFN.path,
       CR.revision,
       NVL2((SELECT 1 FROM rhnConfigFile CFt WHERE CFT.latest_config_revision_id = CR.id), 'Y', 'N') LATEST,
       TO_CHAR(CCon.created, 'YYYY-MM-DD HH24:MI:SS') AS CREATED,
       CASE CCT.label WHEN 'local_override' THEN '(system override)' ELSE CC.name END AS CONFIG_CHANNEL_NAME,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID
  FROM rhnConfigChannelType CCT,
       rhnConfigChannel CC,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigContent CCon,
       rhnConfigRevision CR,
       rhnSet S,
       rhnChecksum Csum
 WHERE S.user_id = :user_id
   AND S.label = :set_label
   AND S.element = CR.id
   AND CR.config_file_id = CF.id
   AND CF.config_channel_id = CC.id
   AND CC.confchan_type_id = CCT.id
   AND CCon.id = CR.config_content_id
   AND CCT.label IN ('normal', 'local_override')
   AND CFN.id = CF.config_file_name_id
   AND CCon.checksum_id = Csum.id
ORDER BY CFN.path
  </query>
</mode>

<mode name="configfilenames_for_import">
  <query params="">
--dummy query
  </query>
</mode>

<mode name="selected_configfilenames">
  <query params="set_label, user_id">
SELECT CFN.id, CFN.path
  FROM rhnSet S, rhnConfigFileName CFN
 WHERE S.user_id = :user_id
   AND S.label = :set_label
   AND S.element = CFN.id
ORDER BY CFN.path
  </query>
</mode>

<mode name="configfiles_for_snapshot">
  <query params="ss_id">
SELECT DISTINCT
       CR.id,
       Csum.checksum md5sum,
       CFN.id AS CONFIG_FILE_NAME_ID,
       CFN.path,
       CR.revision,
       CR.id AS REVISION_ID,
       CR.delim_start,
       CR.delim_end,
       CF.config_channel_id,
       TO_CHAR(CCon.created, 'YYYY-MM-DD HH24:MI:SS') AS CREATED
  FROM rhnConfigContent CCon,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnSnapshotConfigRevision SCR,
       rhnChecksum Csum
 WHERE SCR.snapshot_id = :ss_id
   AND SCR.config_revision_id = CR.id
   AND CR.config_content_id = CCon.id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
   AND CCon.checksum_id = Csum.id
ORDER BY CFN.path
  </query>
</mode>


<mode name="configfiles_for_user">
  <query params="org_id, user_id">
SELECT DISTINCT CFN.id, CFN.path
  FROM rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigChannel CC
 WHERE CC.org_id = :org_id
   AND CF.config_channel_id = CC.id
   AND rhn_config_channel.get_user_file_access(CF.id, :user_id) = 1
   AND CF.config_file_name_id = CFN.id
ORDER BY UPPER(CFN.path)
  </query>
 <elaborator params="org_id, user_id">
SELECT CFN.id,
       count(CF.config_channel_id) AS config_channel_count
  FROM rhnConfigFileName CFN, rhnConfigFile CF, rhnConfigChannel CC
 WHERE CFN.id IN (%s)
   AND CFN.id = CF.config_file_name_id
   AND CF.config_channel_id = CC.id
   AND CC.org_id = :org_id
   AND rhn_config_channel.get_user_chan_access(CC.id, :user_id) = 1
GROUP BY CFN.id
 </elaborator>
</mode>

<mode name="revisions_of_configfile">
  <query params="crid">
SELECT CR.id,
       CR.revision,
       CCon.is_binary
  FROM rhnConfigContent CCon,
       rhnConfigRevision CR,
       rhnConfigFile CF
 WHERE CF.id = (SELECT CR2.config_file_id FROM rhnConfigRevision CR2 WHERE CR2.id = :crid)
   AND CR.config_file_id = CF.id
   AND CCon.id = CR.config_content_id
ORDER BY CR.revision
  </query>
</mode>

<mode name="org_configfile_size_totals">
  <query params="org_id">
SELECT CFN.id AS id,
       CFN.path,
       CC.name AS CONFIG_CHANNEL_NAME,
       CC.label AS CONFIG_CHANNEL_LABEL,
       CC.id AS CONFIG_CHANNEL_ID,
       CF.latest_config_revision_id,
       LCR.revision AS latest_config_revision,
       SUM(CCon.file_size) AS total_file_size
  FROM rhnConfigContent CCon,
       rhnConfigRevision CR,
       rhnConfigRevision LCR,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigChannel CC
 WHERE CC.org_id = :org_id
   AND CF.config_channel_id = CC.id
   AND CFN.id = CF.config_file_name_id
   AND LCR.id = CF.latest_config_revision_id
   AND CR.config_file_id = CF.id
   AND CCon.id = CR.config_content_id
GROUP BY CFN.id, CFN.path, CC.name, CC.label, CC.id, CF.latest_config_revision_id, LCR.revision
ORDER BY total_file_size DESC
  </query>
</mode>

<mode name="config_action_failures">
  <query params="sid, aid">
SELECT CFN.path,
       CR.id,
       CR.revision,
       ACR.id AS ACTION_REVISION_ID,
       CFF.name AS FAILURE_REASON
  FROM rhnConfigFileFailure CFF,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnActionConfigRevision ACR
 WHERE ACR.action_id = :aid
   AND ACR.server_id = :sid
   AND ACR.config_revision_id = CR.id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
   AND ACR.failure_id = CFF.id
ORDER BY UPPER(CFN.path)
  </query>
</mode>

<mode name="config_action_non_failures">
  <query params="sid, aid">
SELECT CFN.path,
       CR.id,
       CR.revision,
       ACR.id AS ACTION_REVISION_ID
  FROM rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnActionConfigRevision ACR
 WHERE ACR.action_id = :aid
   AND ACR.server_id = :sid
   AND ACR.failure_id IS NULL
   AND ACR.config_revision_id = CR.id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
ORDER BY UPPER(CFN.path)
  </query>
</mode>


<mode name="config_action_revisions">
  <query params="aid, sid">
SELECT CFN.path,
       CR.id,
       CR.revision,
       ACR.id AS ACTION_REVISION_ID,
       CFF.name AS FAILURE_REASON
  FROM rhnConfigFileFailure CFF,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnActionConfigRevision ACR
 WHERE ACR.action_id = :aid
   AND ACR.server_id = :sid
   AND ACR.config_revision_id = CR.id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
   AND ACR.failure_id = CFF.id (+)
ORDER BY UPPER(CFN.path)
  </query>
</mode>

<mode name="diff_action_revisions">
  <query params="aid, sid">
SELECT CFN.path,
       CR.id,
       CR.id AS REVISION_ID,
       CR.revision,
       ACR.id AS ACTION_REVISION_ID,
       CFF.name AS FAILURE_REASON,
       rhn_config_channel.action_diff_revision_status(ACR.id) AS STATUS
  FROM rhnConfigFileFailure CFF,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnActionConfigRevision ACR
 WHERE ACR.action_id = :aid
   AND ACR.server_id = :sid
   AND ACR.config_revision_id = CR.id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
   AND ACR.failure_id = CFF.id (+)
ORDER BY UPPER(CFN.path)
  </query>
</mode>


<mode name="diff_action_info">
  <query params="sid, hid">
SELECT ACR.id,
       ACR.id AS ACTION_REVISION_ID,
       CR.id AS REVISION_ID,
       CR.revision,
       CFN.id AS NAME_ID,
       CFN.path,
       rhn_config_channel.action_diff_revision_status(ACR.id) AS STATUS,
       CFF.name AS FAILURE_REASON
  FROM rhnConfigFileFailure CFF,
       rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnActionConfigRevision ACR
 WHERE ACR.server_id = :sid
   AND ACR.action_id = :hid
--   AND rhn_config_channel.action_diff_revision_status(ACR.id) = 'Differences exist'
   AND CR.id = ACR.config_revision_id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
   AND ACR.failure_id = CFF.id (+)
ORDER BY CFN.path
  </query>
</mode>


<mode name="diff_action_differences">
  <query params="sid, hid">
SELECT ACR.id,
       ACR.id AS ACTION_REVISION_ID,
       CR.id AS REVISION_ID,
       CR.revision,
       CFN.id AS NAME_ID,
       CFN.path,
       rhn_config_channel.action_diff_revision_status(ACR.id) AS STATUS
  FROM rhnConfigFileName CFN,
       rhnConfigFile CF,
       rhnConfigRevision CR,
       rhnActionConfigRevision ACR
 WHERE ACR.server_id = :sid
   AND ACR.action_id = :hid
   AND rhn_config_channel.action_diff_revision_status(ACR.id) = 'Differences exist'
   AND CR.id = ACR.config_revision_id
   AND CR.config_file_id = CF.id
   AND CF.config_file_name_id = CFN.id
ORDER BY CFN.path
  </query>
</mode>



<mode name="upload_action_status">
  <query params="sid, aid">
SELECT CFN.path,
       CFF.name AS FAILURE_REASON
  FROM rhnConfigFileFailure CFF,
       rhnConfigFileName CFN,
       rhnActionConfigFileName ACFN
 WHERE ACFN.server_id = :sid
   AND ACFN.action_id = :aid
   AND ACFN.config_file_name_id = CFN.id
   AND ACFN.failure_id = CFF.id (+)
ORDER BY CFN.path
  </query>
</mode>

</datasource_modes>

